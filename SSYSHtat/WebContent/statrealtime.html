<!DOCTYPE>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <!--[if lte IE 8]>
    <script language="javascript" type="text/javascript" src="js/excanvas.min.js"></script>
    <![endif]-->
    <script type="text/javascript" src="js/jquery-1.10.1.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/jquery.flot.js"></script>
    <script type="text/javascript" src="js/json_parse.js"></script>
    <title>后台管理</title>
</head>
<body>
    <div class="panel panel-primary" style="width: 180px;float: left;box-shadow: 0 0 10px #aaa">
        <div class="panel-heading" style="font-size: 24px;line-height: 40px;text-align: center;text-shadow: 0 0 10px #000;">后台管理</div>
        <div class="panel-body" style="font-size: 20px;text-align: center;">
            <a href="itemsugmanage.html">商品信息</a>
        </div>
        <div class="panel-body" style="font-size: 20px;text-align: center">
            <a href="statrealtime.html">统计信息</a>
        </div>
        <div class="panel-body" style="font-size: 20px;text-align: center">
            <a href="keyWord.html">关键字查询</a>
        </div>
        <div class="panel-body" style="font-size: 20px;text-align: center">
            <a href="showGoods.html">商品库管理</a>
        </div>
    </div>
    <div class="panel panel-default main-panel" id="content" style="width: 1200px">
        <div class="panel-heading">
            <h1 style="display: inline;" class="panel-title">实时查询</h1>
            <button type="button" class="btn btn-mini btn-info" onclick="location.href='statmanage.html'" style="float: right">历史查询</button>
        </div>
        <div class="panel-body" style="position: relative;">
            <input value="19905624649" type="text" style="vertical-align: top;width: 160px;display: inline-block;margin-left: 80px;" class="form-control"/>
            <button class="btn btn-primary" style="vertical-align: top;" onclick="getJson2()">提交pid</button>
            <select id="type" class="form-control" style="vertical-align: top;" onchange="getJson2()">
                <!--<option>查看类型</option>-->
                <option>订单数量</option>
                <option>订单件数</option>
                <option>确认收货</option>
                <option>浏览数量</option>
                <option>收藏数量</option>
            </select>
            <button type="button" class="btn btn-success result" style="vertical-align: top;margin-left: 50px">( x , y )</button>
            <div id="placeholder"></div>
        </div>
    </div>

<!--设置页面高度-->
<script type="text/javascript">
    $(document).ready(function(){
        var height = $(window).height();
        //alert(height);
        if(height>760){
            $('.panel-primary').height(height);
        }
        else{
            $('.panel-primary').height(760);
        }
    })
</script>

<script type="text/javascript">
var arrPay = [];
var arrPay_i = [];
var arrP_count = [];
var arrB_count = [];
var arrS_count = [];
var arrCre = [];
var arrCre_i = [];
var arrInv = [];
var arrInv_i = [];
var arrSuc = [];
var arrSuc_i = [];
var arrClo = [];
var arrClo_i = [];
var tag;
var realRe;
function getJson2(){
    var pid = $('input').val();
    tag = translate($('#type option:selected').val());//获取类型值
    $.ajax({
        url:'FetchRealTimeStat?pid='+pid+'&'+'tag='+tag,
        type:'GET',
        async:false,
        success:function(ret){
            realRe = JSON.parse(ret);   //解析响应数据
            switch (tag){
                case "order":
                    for(var i = 0; i<24; i++){
                        arrCre[i] = [i,realRe.create[i]];
                        arrCre_i[i] = [i,realRe.create_i[i]];
                        arrPay[i] = [i,realRe.pay[i]];
                        arrPay_i[i] = [i,realRe.pay_i[i]];
                        arrInv[i] = [i,realRe.invalid[i]];
                        arrInv_i[i] = [i,realRe.invalid_i[i]];
                        arrSuc[i] = [i,realRe.success[i]];
                        arrSuc_i[i] = [i,realRe.success_i[i]];
                        arrClo[i] = [i,realRe.close[i]];
                        arrClo_i[i] = [i,realRe.close_i[i]];
                    }
                    break;
                case "purchase":
                    for(var i = 0; i<24; i++){
                        arrP_count[i] = [i,realRe.p_count[i]];
                    }
                    break;
                case "browse":
                    for(var i = 0; i<24; i++){
                        arrB_count[i] = [i,realRe.b_count[i]];
                    }
                    break;
                case "store":
                    for(var i = 0; i<24; i++){
                        arrS_count[i] = [i,realRe.s_count[i]];
                    }
                    break;
                default :
                    break;
            }
            var dataLine = [];
            var line1 = { label:"订单付款", data:arrPay };
            var line2 = { label:"付款件数", data:arrPay_i };
            var line3 = { label:"订单创建", data:arrCre };
            var line4 = { label:"创建件数", data:arrCre_i };
            var line5 = { label:"订单失效", data:arrInv };
            var line6 = { label:"失效件数", data:arrInv_i };
            var line7 = { label:"订单成功", data:arrSuc };
            var line8 = { label:"成功件数", data:arrSuc_i };
            var line9 = { label:"订单结算", data:arrClo };
            var line10 = { label:"结算件数", data:arrClo_i };
            var line11 = { label:"确认收货", data:arrP_count };
            var line12 = { label:"浏览数量", data:arrB_count };
            var line13 = { label:"收藏数量", data:arrS_count };
            
            var retType = $('#type option:selected').val();//选择查看的类型值
            
            switch (retType){
                case "订单数量":
                    dataLine.push(line1,line3,line5,line7,line9);
                    break;
                case "订单件数":
                    dataLine.push(line2,line4,line6,line8,line10);
                    break;
                case "确认收货":
                    dataLine.push(line11);
                    break;
                case "浏览数量":
                    dataLine.push(line12);
                    break;
                case "收藏数量":
                    dataLine.push(line13);
                    break;
                default :
                    dataLine.push(line1,line2,line3,line4,line5,line6,line7,line8,line9,line10,line11,line12,line13);
                    break;
            }
            var lMax = 0;
            for(var i=0; i<dataLine.length; i++){
                for(var j=0; j<24; j++){
                	console.info(dataLine[i].data[j][1]);
                	lMax = Math.max(lMax,dataLine[i].data[j][1]);
                } 
            }
            console.info(lMax);
            $(function(){
            	console.info(lMax);
                var options = {
                    lines: { show: true, fill:true },
                    points: { show: true },
                    grid: { hoverable: true, clickable: true, borderColor:'#000',borderWidth:1},  
                    xaxis: {
                        min:  0,
                        max: 23,
                        tickDecimals: 0,
                        tickSize: 1
                    },
                    yaxis: {
                        min:  0,
                        max: lMax+1,
                        tickDecimals: 0
                    }
                };
                var placeholder = $("#placeholder");
                $.plot(placeholder, dataLine, options);
            });
            $("#placeholder").bind("plotclick",function (event,pos, item) {
                $(".result").html('( '+Math.round(pos.x)+ " , " +Math.round(pos.y)+' )');
                if (item)
                {
                    console.log(item.series,item.datapoint);
                    console.log("Youclicked a point!");
                }
            });
        }
    });
}
function translate(key){
    var dict = {"订单数量":"order","订单件数":"order","确认收货":"purchase","浏览数量":"browse","收藏数量":"store","商品ID":"pid"};
    return dict[key];
} 
</script>
</body>
</html>